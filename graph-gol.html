<!DOCTYPE html>

<html>
<head>
<link rel="stylesheet" type="text/css" href="graph.css">
<link href='https://fonts.googleapis.com/css?family=Roboto:300' rel='stylesheet' type='text/css'>
</head>

<body>

<div id = "canvasbox">
	<canvas id = "graph">Your browser does not support the HTML5 canvas tag.</canvas>
</div>

<div id = "menu">
	<p style = "text-align: center;">info</p>
	<p id = "fps">fps: 0</p>
	<h1>Game of Life</h1>
	<p>Draw alive cells and press the q,w,e,r,t,y keys to choose the play speed and p to pause. </p>
	<p>Grid size:</p>
	<div style="width:400px;height:100px;">
		<p class = "hoverbutton" id = "reset" >reset</p>
		<p class = "hoverbutton" id = "bb" >2</p>
		<p class = "hoverbutton" id = "cc" >5</p>
		<p class = "hoverbutton" id = "dd" >10</p>
		<p class = "hoverbutton" id = "ee" >20</p>
		<p class = "hoverbutton" id = "ff">50</p>
	</div>
	<p>Depending on the number of neighbours, a cell will die, survive, or be born.</p>
	<p>Choose which cells survive and are born:</p>
	<div style="width:400px;height:50px;">
		<p style="width:150px;float:left;">survival: </p>
		<div class="squaredFour">
			<p style="margin-left:5px;height: 5px;">0</p>
			<input type="checkbox" value="None" id="survival0" name="check0" onclick="survival[0]=document.getElementById('survival0').checked"/>
			<label for="survival0"></label>
		</div>
		<div class="squaredFour">
			<p style="margin-left:5px;height: 5px;">1</p>
			<input type="checkbox" value="None" id="survival1" name="check1" onclick="survival[1]=document.getElementById('survival1').checked" />
			<label for="survival1"></label>
		</div>
		<div class="squaredFour">
			<p style="margin-left:5px;height: 5px;">2</p>
			<input type="checkbox" value="None" id="survival2" name="check2" onclick="survival[2]=document.getElementById('survival2').checked" />
			<label for="survival2"></label>
		</div>
		<div class="squaredFour">
			<p style="margin-left:5px;height: 5px;">3</p>
			<input type="checkbox" value="None" id="survival3" name="check3" onclick="survival[3]=document.getElementById('survival3').checked" />
			<label for="survival3"></label>
		</div>
		<div class="squaredFour">
			<p style="margin-left:5px;height: 5px;">4</p>
			<input type="checkbox" value="None" id="survival4" name="check4" onclick="survival[4]=document.getElementById('survival4').checked" />
			<label for="survival4"></label>
		</div>
		<div class="squaredFour">
			<p style="margin-left:5px;height: 5px;">5</p>
			<input type="checkbox" value="None" id="survival5" name="check5" onclick="survival[5]=document.getElementById('survival5').checked" />
			<label for="survival5"></label>
		</div>
		<div class="squaredFour">
			<p style="margin-left:5px;height: 5px;">6</p>
			<input type="checkbox" value="None" id="survival6" name="check6" onclick="survival[6]=document.getElementById('survival6').checked" />
			<label for="survival6"></label>
		</div>
		<div class="squaredFour">
			<p style="margin-left:5px;height: 5px;">7</p>
			<input type="checkbox" value="None" id="survival7" name="check7" onclick="survival[7]=document.getElementById('survival7').checked" />
			<label for="survival7"></label>
		</div>
		<div class="squaredFour">
			<p style="margin-left:5px;height: 5px;">8</p>
			<input type="checkbox" value="None" id="survival8" name="check8" onclick="survival[8]=document.getElementById('survival8').checked" />
			<label for="survival8"></label>
		</div>
	</div>

	<div style="width:400px;height:60px;">
		<p style="width:150px;float:left;">birth: </p>
		<div class="squaredFour">
			<p style="margin-left:5px;height: 5px;">0</p>
			<input type="checkbox" value="None" id="birth0" name="check0" onclick="birth[0]=document.getElementById('birth0').checked" />
			<label for="birth0"></label>
		</div>
		<div class="squaredFour">
			<p style="margin-left:5px;height: 5px;">1</p>
			<input type="checkbox" value="None" id="birth1" name="check1" onclick="birth[1]=document.getElementById('birth1').checked" />
			<label for="birth1"></label>
		</div>
		<div class="squaredFour">
			<p style="margin-left:5px;height: 5px;">2</p>
			<input type="checkbox" value="None" id="birth2" name="check2" onclick="birth[2]=document.getElementById('birth2').checked" />
			<label for="birth2"></label>
		</div>
		<div class="squaredFour">
			<p style="margin-left:5px;height: 5px;">3</p>
			<input type="checkbox" value="None" id="birth3" name="check3" onclick="birth[3]=document.getElementById('birth3').checked" />
			<label for="birth3"></label>
		</div>
		<div class="squaredFour">
			<p style="margin-left:5px;height: 5px;">4</p>
			<input type="checkbox" value="None" id="birth4" name="check4" onclick="birth[4]=document.getElementById('birth4').checked" />
			<label for="birth4"></label>
		</div>
		<div class="squaredFour">
			<p style="margin-left:5px;height: 5px;">5</p>
			<input type="checkbox" value="None" id="birth5" name="check5" onclick="birth[5]=document.getElementById('birth5').checked" />
			<label for="birth5"></label>
		</div>
		<div class="squaredFour">
			<p style="margin-left:5px;height: 5px;">6</p>
			<input type="checkbox" value="None" id="birth6" name="check6" onclick="birth[6]=document.getElementById('birth6').checked" />
			<label for="birth6"></label>
		</div>
		<div class="squaredFour">
			<p style="margin-left:5px;height: 5px;">7</p>
			<input type="checkbox" value="None" id="birth7" name="check7" onclick="birth[7]=document.getElementById('birth7').checked" />
			<label for="birth7"></label>
		</div>
		<div class="squaredFour">
			<p style="margin-left:5px;height: 5px;">8</p>
			<input type="checkbox" value="None" id="birth8" name="check8" onclick="birth[8]=document.getElementById('birth8').checked" />
			<label for="birth8"></label>
		</div>
	</div>
	<h3>Try these rule sets:</h3>
	<p>
		Game of life (default) S: 23, B: 3 </br>
		Maze S: 12345, B: 3 </br>
		Life without death S: 012345678, B: 3 </br>
		Day and Night S: 34678, B: 3678 </br>
		Move S: 245, B: 368 </br>
		Walled cities S: 2345, B: 45678 </br>
	</p>
</div>

<div id = "footer">
	<p style = "text-align:center;"><a href="graph-fluid.html">previous</a> | <a href="graph-maze.html">next</a> </p>
</div>

<script>

	// Initialise canvas
	var c = document.getElementById("graph");
	var paper = c.getContext("2d");
	W=window.innerWidth;
	H=window.innerHeight;
	c.width = W;
	c.height = H;
	paper.fillStyle = '#fff';
	paper.fillRect(0,0,W,H);
	
	// Initialise rules
	document.getElementById("survival2").checked = true;
	document.getElementById("survival3").checked = true;
	document.getElementById("birth3").checked = true;
	var survival = [0,0,1,1,0,0,0,0,0];
	var birth = [0,0,0,1,0,0,0,0,0];
	
	// Initialise board
	var dx = 20;
	var xs = [];
	var ys = [];
	var life = [];
	var pastlife = [];
	for (var i = 0; i < W/dx+1; i++){
		xs[i]=[];
		ys[i]=[];
		life[i] = [];
		pastlife[i] = [];
		for (var j = 0; j < H/dx+1; j++){
			xs[i][j] = (i-1)*dx+dx/2+.5;
			ys[i][j] = (j-1)*dx+dx/2+.5;
			life[i][j] =0;
			pastlife[i][j] =0;
		}
	}

	var xpos = -1;
	var ypos = -1;
	var clicked = 0;
	var stop = 1;
	var qwerty = 0;
	drawlines(xs,ys,W,H,dx);

	function init(){
		paper.fillStyle = 'rgba(255,255,255,1)';
		paper.fillRect(0,0,W,H);
		xs = [];
		ys = [];
		life = [];
		pastlife = [];
		for (var i = 0; i < W/dx+1; i++){
			xs[i]=[];
			ys[i]=[];
			life[i] = [];
			pastlife[i] = [];
			for (var j = 0; j < H/dx+1; j++){
				xs[i][j] = (i-1)*dx+dx/2+.5;
				ys[i][j] = (j-1)*dx+dx/2+.5;
				life[i][j] =0;
				pastlife[i][j] =0;
			}
		}

		xpos = -1;
		ypos = -1;
		clicked = 0;
		qwerty = 0;
		stop = 1;
		if (dx>=10){
			drawlines(xs,ys,W,H,dx);
		}
	}

	function animate( render ) {
		var running, lastFrame = +new Date;
		function loop( now ) {
			// stop the loop if render returned false
			if ( running !== false ) {
				if (render == draw){
					requestAnimationFrame( loop );
				} else {
					setTimeout(function(){requestAnimationFrame( loop );},qwerty);
				}
				var deltaT = now - lastFrame;
				document.getElementById("fps").innerHTML = "fps: " + 1000/deltaT;

				// do not render frame when deltaT is too high
				if ( deltaT < 2000) {
					running = render( deltaT );
				}
				lastFrame = now;
			} else {
				document.getElementById("fps").innerHTML = "fps: 0";
			}
		}
		loop( lastFrame );
	}

	function draw(dt){
		if(clicked){
			//paper.fillStyle = 'rgba(255,255,255,1)';
			//paper.fillRect(0,0,W,H);
			gridi = parseInt((xpos-(dx/2+.5))/dx+1);
			gridj = parseInt((ypos-(dx/2+.5))/dx+1);
			life[gridi][gridj] = 1;
			drawlife(xs,ys,W,H,dx);
			if(dx>=10){
				drawlines(xs,ys,W,H,dx);
			}
			copy(life,pastlife);
		} else {
			return false;
		}
	}
	
	function run(dt){
		runlife();
		//paper.fillStyle = 'rgba(255,255,255,1)';
		//paper.fillRect(0,0,W,H);
		drawlife(xs,ys,W,H,dx);
		if(dx>=10){
			drawlines(xs,ys,W,H,dx);
		}
		if (stop){
			return false;
		}
	}

	function drawlines(xs,ys,W,H,dx){
		paper.strokeStyle="#bce";
		for (var i = 0; i < W/dx; i++){
			for (var j = 0; j < H/dx; j++){	
				paper.beginPath();
				paper.moveTo(xs[i][j],ys[i][j]);
				paper.lineTo(xs[i+1][j], ys[i+1][j]);
				paper.lineTo(xs[i+1][j+1],ys[i+1][j+1]);
				paper.stroke();
			}
		}
	}

	function drawlife(xs,ys,W,H,dx){
		for (var i = 0; i < W/dx; i++){
			for (var j = 0; j < H/dx; j++){
				if (life[i][j]!=pastlife[i][j]){
					if(life[i][j]){
						paper.fillStyle="#bce";
					} else {
						paper.fillStyle="#fff";
					}
					paper.beginPath();
					if (dx<5){
						paper.moveTo(xs[i][j]+.5,ys[i][j]+.5);
						paper.lineTo(xs[i+1][j]+.5, ys[i+1][j]+.5);
						paper.lineTo(xs[i+1][j+1]+.5, ys[i+1][j+1]+.5);
						paper.lineTo(xs[i][j+1]+.5,ys[i][j+1]+.5);
						paper.moveTo(xs[i][j]+.5,ys[i][j]+.5);
					} else{
						paper.moveTo(xs[i][j],ys[i][j]);
						paper.lineTo(xs[i+1][j], ys[i+1][j]);
						paper.lineTo(xs[i+1][j+1], ys[i+1][j+1]);
						paper.lineTo(xs[i][j+1],ys[i][j+1]);
						paper.moveTo(xs[i][j],ys[i][j]);					
					}
					paper.fill();
				}
			}
		}
	}

	function runlife(){
		copy(life,pastlife);
		for (var i = 1; i < W/dx-1; i++){
			for (var j = 1; j < H/dx-1; j++){
				evolve(i,j);
			}
		}
	}

	function copy(from,to){
		for (var i = 1; i < W/dx-1; i++){
			for (var j = 1; j < H/dx-1; j++){
				to[i][j] = from[i][j];
			}
		}
	}

	function evolve(i,j){
		var count = 0;
		for (var k = i-1;k<=i+1;k++){
			for (var l = j-1; l<=j+1; l++){
				if (pastlife[k][l]){
					count ++;
				}
			}
		}
		count-=pastlife[i][j];
		life[i][j]=0;
		if(survival[count]&&pastlife[i][j]){
			life[i][j]=1;
		} else if (birth[count]&&!pastlife[i][j]) {
			life[i][j]=1;
		}
	}

	document.getElementById("canvasbox").onmousemove = coords;
	document.getElementById("canvasbox").onmousedown = click;
	document.getElementById("canvasbox").onmouseup = declick;

	function coords(e){
		xpos = e.clientX;
		ypos = e.clientY;
	}

	function click (){
		clicked = 1;
		animate(draw);
	}
	function declick (){
		clicked = 0;
	}

	document.onkeydown = keypressed;

	function keypressed(e) {

		e = e || window.event;

		if (e.keyCode == '81' || e.keyCode == '13' || e.keyCode == '32') {
			// q
			if (qwerty == 0){
				setTimeout(run(qwerty),qwerty);
			}
			qwerty=0;
			stop = 1;
		}
		else if (e.keyCode == '87') {
			// w
			changespeed(1000);
		}
		else if (e.keyCode == '69') {
		    // e
			changespeed(500);
		}
		else if (e.keyCode == '82') {
			// r
			changespeed(100);
		}
		else if (e.keyCode == '84') {
		    // t
			changespeed(50);
		}
		else if (e.keyCode == '89') {
			// y
			changespeed(1);
		}
	}
	
	function changespeed(speed) {
		if (qwerty != speed){
			if (qwerty == 0){
				stop = 1;
				qwerty = speed;
				setTimeout(function(){stop=0;animate(run);}, qwerty);
			} else {
				qwerty = speed;
			}
		} else {
			stop = 1;
			qwerty = 0;
		}
	}
	
	window.onload = function() {
		reset.onmousedown = function() {
			stop = 1;
			setTimeout(init, 1000);
			return false;
		}
		bb.onmousedown = function() {
			stop = 1;
			dx = 2;
			setTimeout(init, 1000);
			return false;
		}
		cc.onmousedown = function() {
			stop = 1;
			dx = 5;
			setTimeout(init, 1000);
			return false;
		}
		dd.onmousedown = function() {
			stop = 1;
			dx = 10;
			setTimeout(init, 1000);
			return false;
		}
		ee.onmousedown = function() {
			stop = 1;
			dx = 20;
			setTimeout(init, 1000);
			return false;
		}
		ff.onmousedown = function() {
			stop = 1;
			dx = 50;
			setTimeout(init, 1000);
			return false;
		}
	}
	
</script>

</body>
</html>


